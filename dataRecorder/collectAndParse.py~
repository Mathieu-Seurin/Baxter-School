#!/usr/bin/python
#coding: utf-8
from __future__ import division
import numpy as np
import rosbag
import rospy
from arm_scenario_experiments import Recorder
from baxter_interface import Head, Limb

import matplotlib.pyplot as plt
from cv_bridge import CvBridge, CvBridgeError

import scipy.misc
import subprocess

def moveHead(head,direction):
    if direction==1 and head.pan()>1.3:
        direction = -1
    elif direction==-1 and head.pan()<-1.3:
        direction = 1

    head.set_pan(head.pan()+0.10*direction)
    time.sleep(0.5)
    return direction

directory = 'moreData/pose02_head_pan/'
bagPath = 'bag'

#============= INIT ==================
#=====================================
bridge = CvBridge()
bag = rosbag.Bag('bag/record.bag')
#bag = rosbag.Bag('here/pose2_head_pan.bag')

print bag

subprocess.call(["mkdir", directory])
subprocess.call(["mkdir", directory+'Images'])

rospy.init_node('dataCollector')

#recorder = Recorder(path, 'test')
recorder = Recorder(path, 'test', ['/cameras/head_camera_2/image','/robot/joint_states'])

head = Head()

rospy.loginfo('Starting recording right now')
recorder.new_bag('record')
recording = True

direction = -1
head.set_pan(1.31)
time.sleep(2)


#============= COLLECTING DATA =======
#=====================================
step = 0
try:
    while not rospy.is_shutdown() and step < 75:
        step += 1
        direction = moveHead(head,direction)
        recorder.check_topics()
        recorder.dump_all()

except rospy.ROSInterruptException: 
    pass


#============= Parsing DATA =========
#=====================================
lastTopic = None
totImg = 0
txt_file = ''

for topic, msg, t in bag.read_messages():

    if lastTopic == topic:
        continue

    if topic=='test/cameras/head_camera_2/image':
        img = bridge.imgmsg_to_cv2(msg,'rgb8')
        scipy.misc.toimage(img, cmin=0, cmax=255).save('{}Images/frame{}.jpg'.format(directory, str(totImg).zfill(4)))
        totImg += 1

    else:
        if txt_file=='':
            txt_file = '# time '+' '.join(msg.name)+'\n'
        txt_file += str(t)[:-8]+' '+' '.join(map(str,msg.position))+'\n'

    lastTopic = topic
    

                                                       
f = open(directory+'robot_joint_states.txt','w')
f.write(txt_file)
f.close()
bag.close()
